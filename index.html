<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="index.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="my-3">
            <label for="upload-file" class="form-label">Upload pairwise distances file</label>
            <input type="file" class="form-control" id="upload-file" />
        </div>
        <button id="read-file" class="btn btn-primary mt-3">Submit</button>

        <script type="module" async>
            // ----------- GLOBAL VARIABLES ------------
            // size of chunks to read from uploaded file
            const CHUNK_SIZE = 1024 * 1024 * 10;
            // threshold for pairwise distances to be added to map
            const threshold = 0.015;
            // map of all pairwise distances
            const pairwiseDistances = new Map();
            // for logging time elapsed
            let previousTime = performance.now();

            document.getElementById("read-file").addEventListener("click", async () => {
                if (!document.getElementById("upload-file").files[0]) {
                    alert("Please select a file");
                    return;
                }

                await getPairwiseDistances();
            })


            // ----------- PAIRWISE DISTANCE MAP GENERATION ------------

            const getPairwiseDistances = async () => {
                const file = document.getElementById("upload-file").files[0];
                log("Reading file...", false)
                
                const array = await readFileAsync(file);
                log("Done reading file...")

                const decoder = new TextDecoder("utf-8");
                // for when the chunk_size split doesn't match a full line
                let splitString = ""; 

                // iterate over the file in chunks, readAsText can't read the entire file 
                for (let i = 0; i < array.byteLength; i += CHUNK_SIZE) {
                    // get individual pairwise distances
                    const text = decoder.decode(array.slice(i, i + CHUNK_SIZE));
                    const lines = text.split("\n")
                    for (let j = 0; j < lines.length; ++j) {
                        // line represents a single pairwise distance entry
                        let line = lines[j];
                        let columns = line.split("\t");
                        
                        // edge case: very first line of file
                        if (i === 0 && j === 0) {
                            continue;
                        }

                        // edge case: first line is split
                        if (j === 0 && columns.length < 3) {
                            
                            line = splitString + line;
                            splitString = "";
                            columns = line.split("\t")
                        }

                        // edge case: last line is split
                        if (j === lines.length - 1 && lines[j].length > 0) {
                            splitString = line;
                            continue;
                        }

                        // add to map of all pairwise distances if below threshold
                        if (parseFloat(columns[2]) < threshold) {
                            pairwiseDistances.set(columns[0] + '-' + columns[1], parseFloat(columns[2]));
                        }
                    }
                }
                log("Done parsing file...")
            }

            // helper function to promise-fy file read  
            const readFileAsync = async (file) => {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                })
            }

            // ----------- GENERAL HELPER FUNCTIONS ------------ 
            
            const log = (message, showElapsed=true) => {
                console.log(message);
                showElapsed && console.log("Time elapsed: " + (performance.now() - previousTime) + "ms")
                previousTime = performance.now();
            }
        </script>
    </body>
</html>