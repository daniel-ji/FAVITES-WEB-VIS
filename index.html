<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="index.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="my-3">
            <label for="upload-file" class="form-label">Upload pairwise distances file</label>
            <input type="file" class="form-control" id="upload-file" />
        </div>
        <button id="read-file" class="btn btn-primary mt-3">Submit</button>

        <script type="module" async>
            const CHUNK_SIZE = 1024 * 1024 * 10;
            const pairwiseDistances = new Map();
            const threshold = 0.015;

            document.getElementById("read-file").addEventListener("click", async () => {
                if (!document.getElementById("upload-file").files[0]) {
                    alert("Please select a file");
                    return;
                }

                const startTime = performance.now()
                const file = document.getElementById("upload-file").files[0];
                const reader = new FileReader();
                let splitString = ""; 

                for (let i = 0; i < file.size; i += CHUNK_SIZE) {
                    const array = await readFileAsync(reader, file.slice(i, i + CHUNK_SIZE));
                    const decoder = new TextDecoder("utf-8");
                    const text = decoder.decode(array);
                    const lines = text.split("\n")
                    for (let j = 0; j < lines.length; j++) {
                        let line = lines[j];
                        let columns = line.split("\t");
                        
                        // edge case: first line is split
                        if (j === 0 && columns.length < 3) {
                            line = splitString + line;
                            splitString = "";
                            columns = line.split("\t")
                        }

                        // edge case: last line is split
                        if (j === lines.length && columns.length < 3) {
                            splitString = line;
                            continue;
                        }

                        if (parseFloat(columns[2]) < threshold) {
                            pairwiseDistances.set(columns[0] + '-' + columns[1], parseFloat(columns[2]));
                        }
                    }
                }

                console.log(pairwiseDistances);
                console.log("Time taken: " + (performance.now() - startTime) + "ms")
            })

            const readFileAsync = async (reader, file) => {
                return new Promise((resolve, reject) => {
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                })
            }
        </script>
    </body>
</html>